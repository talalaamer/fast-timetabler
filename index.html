<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAST TimeTabler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"
        integrity="sha512-dlPw+ytv/6JyepmelABrgeYgHI0O+frEwgfnPdXDTOIZz+eDgfW07QXG02/O8COfivBdGNINy+Vex+lYmJ5rxw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.5.0/luxon.min.js"
        integrity="sha512-SN7iwxiJt9nFKiLayg3NjLItXPwRfBr4SQSIugMeBFrD4lIFJe1Z/exkTZYAg3Ul+AfZEGws2PQ+xSoaWfxRQQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</head>

<body>
    <div class="container mt-5">
        <form class="row g-3 justify-content-center" id="form">
            <input class="form-control mb-3" type="file" id="fileInput" accept=".xlsx, .xls">
            <div class="col-auto">
                <select class="form-select mt-2" id="degreeSelect">
                    <option selected>Choose Degree</option>
                </select>
            </div>
            <div class="col-auto  d-flex align-items-center">
                <label for="classAndSectionInput" class="form-label mb-0">Class & Section</label>
                <input type="text" class="form-control" id="classAndSectionInput" placeholder="SE-C">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary mt-2" id="generateTable">Generate Timetable</button>
            </div>
        </form>
        <div id="htmlOutput"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">

        import { markdownTable } from 'https://esm.sh/markdown-table@3?bundle';
        const { DateTime } = luxon;

        let globalWorkbook;
        let globalCourses;

        document.getElementById('fileInput').addEventListener('change', function (event) {

            const file = event.target.files[0];
            if (!file) return;

            console.log('File selected:', file.name);

            const reader = new FileReader();
            const degreeSelect = document.getElementById('degreeSelect')

            reader.onload = async function (e) {

                try {

                    const data = new Uint8Array(e.target.result);
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(data);

                    globalWorkbook = workbook;

                    const sheet = workbook.worksheets[1]
                    const courseCells = removeDuplicateCellValues(sheet.getRows(1, 4).map(getAllCells).flat().filter(cell => parseInt(cell.col) > 4)).filter(cell => cell.value);

                    globalCourses = courseCells;

                    courseCells.forEach(cell => {
                        if (Array.from(degreeSelect.options).some(option => option.text === cell.value)) return;
                        const option = document.createElement('option')
                        option.value = cell.value
                        option.textContent = cell.value
                        degreeSelect.appendChild(option)
                    })

                } catch (error) { console.error('Error processing file:', error); }
            };

            reader.onerror = function (error) {
                console.error('FileReader error:', error);
            };

            reader.readAsArrayBuffer(file);
        })

        document.getElementById('generateTable').addEventListener('click', function (event) {

            event.preventDefault();

            const sortedClasses = [];
            const chosenCourse = globalCourses.map(cell => cell.value).indexOf(document.getElementById('degreeSelect').value);
            const classAndSection = document.getElementById('classAndSectionInput').value;

            console.log(classAndSection)

            for (const sheet of globalWorkbook.worksheets.slice(1)) {

                const day = sheet.getCell('A1').value;
                const classCells = removeDuplicateCellValues(sheet.getRows(6, sheet.actualRowCount).map(getAllCells).flat().filter(cell => parseInt(cell.col) > 1)).filter(cell => cell.value)
                const courseColor = globalCourses[chosenCourse].fill.bgColor.argb;
                const times = getAllCells(sheet.getRow(5)).filter(cell => parseInt(cell.col) > 1)
                const rooms = getAllCells(sheet.getColumn(1)).filter(cell => parseInt(cell.row) > 5)

                const chosenClasses = classCells.filter(cell => { return cell.fill?.bgColor?.argb == courseColor && cell.value.toLowerCase().includes(classAndSection.toLowerCase()) })

                sortedClasses.push(...chosenClasses.flatMap(cell => extractInfo(cell, rooms, times)).map(info => { info.day = day; return info }).sort((a, b) => {
                    let startTimeA = DateTime.fromFormat(a.startTime, 'HH:mm');
                    let startTimeB = DateTime.fromFormat(b.startTime, 'HH:mm');
                    if (startTimeA < DateTime.fromFormat('8:30', 'H:mm')) startTimeA = startTimeA.plus({ hours: 12 });
                    if (startTimeB < DateTime.fromFormat('8:30', 'H:mm')) startTimeB = startTimeB.plus({ hours: 12 });
                    return startTimeA < startTimeB ? -1 : 1
                }))

            }

            document.getElementById('htmlOutput').innerHTML = marked.parse(markdownTable([['Day', 'Class', 'Room', 'Start Time', 'End Time'], ...sortedClasses.map(info => [info.day, info.name, info.room, info.startTime, info.endTime])]));

            const table = document.querySelector('#htmlOutput table');
            if (!table) return;
            table.classList.add('table');
            table.classList.add('table-hover');
            table.classList.add('table-bordered')

            document.getElementById('form').classList.add('d-none')

        })

        function extractInfo(cell, rooms, times) {

            cell.value = cell.value.trim()

            if (cell.value.includes('     ')) {
                return cell.value.split('     ')
                    .map(info => extractInfo({ ...cell, value: info, row: cell.row, col: cell.col }, rooms, times))
            }

            const room = rooms.find(roomCell => roomCell.row == cell.row).value

            let time;
            try {
                if (!cell.value.includes(':')) time = times.find(timeCell => timeCell.col == cell.col).value
            } catch (error) {
                console.error(`Could not find the time slot for cell at ${cell.col} ${cell.row} ${cell.value}`)
            }

            let endTime;
            let currentCell = cell

            while (true) {
                if (currentCell && cell.worksheet?.getCell(currentCell.row, parseInt(currentCell.col) + 1).value == currentCell.value && currentCell.value) currentCell = cell.worksheet?.getCell(currentCell.row, parseInt(currentCell.col) + 1)
                else break;
            }

            try {
                if (!currentCell.value.includes(':')) endTime = times.find(timeCell => timeCell.col == currentCell.col).value
            } catch (error) {
                console.error(`Could not find the end time slot for cell at ${currentCell.col} ${currentCell.row} ${currentCell.value}`)
            }

            return { name: time ? cell.value : cell.value.slice(0, cell.value.indexOf(')') + 1), startTime: time ? time.match(/(\d+):(\d+)/g)[0] : cell.value.match(/(\d+):(\d+)/g)[0], endTime: endTime ? endTime.match(/(\d+):(\d+)/g)[1] : (time ? time.match(/(\d+):(\d+)/g)[1] : cell.value.match(/(\d+):(\d+)/g)[1]), room: room }
        }

        function getAllCells(row) {
            const cells = [];
            row.eachCell(cell => cells.push(cell));
            return cells
        }

        function removeDuplicateCellValues(cellArray) {
            const seenValues = new Set();
            const uniqueCells = [];
            cellArray.forEach(cell => {
                if (seenValues.has(cell.value)) return;
                seenValues.add(cell.value)
                uniqueCells.push(cell)
            })
            return uniqueCells;
        }

    </script>

</body>

</html>
